---
# Source: devconf-template/templates/namespace.yaml
apiVersion: v1
kind: Namespace
metadata:
  name: '-'
spec:
---
# Source: devconf-template/templates/pullSecret.yaml
apiVersion: v1
data:
  .dockerconfigjson: ""
kind: Secret
metadata:
  creationTimestamp: null
  name: kubevirt2-pull-secret
  namespace: local-cluster
---
# Source: devconf-template/templates/cte-sc.yaml
apiVersion: storage.k8s.io/v1
kind: StorageClass
metadata:
  name: cte-sc-default-cluster-definition-bare-cp
provisioner: csi.cte.cpl.thalesgroup.com
reclaimPolicy: Delete
volumeBindingMode: Immediate
allowVolumeExpansion: true
parameters:

  # Domain name or IP address of the CipherTrust Manager (Required)
  key_manager_addr: 13.212.115.178

  # Name of the CipherTrust Manager K8s Storage Group. (Required)
  k8_storage_group: sg-default-cluster-definition-bare-cp

  # Kubernetes Secret with CM registration token (Required)
  registration_token_secret: cte-reg-token

  source_storage_class: 

  default_policy: policy-default-cluster-definition-bare-cp
  # Time in minutes to wait before unregistering from the CipherTrust Manager
  # once all of the volumes have been unguarded. Parameter must be added as a string
  # integer value. Default is 10 minutes. (Optional)

  allow_source_pvc_delete: "true"
  registration_period: "10"
---
# Source: devconf-template/templates/cte-eso.yaml
# presumes external secrets operator
# this is a hack for now.
---
# Source: devconf-template/templates/sshkey-eso.yaml
# use global ssh key for now
---
# Source: devconf-template/templates/cte-eso.yaml
apiVersion: "external-secrets.io/v1beta1"
kind: ExternalSecret
metadata:
  name: eso-cte-reg-token
  namespace: default-cluster-definition-bare-cp
spec:
  refreshInterval: 15s
  secretStoreRef:
    name: vault-backend
    kind: ClusterSecretStore
  target:
    name: cte-reg-token
    template:
      type: Opaque
  dataFrom:
  - extract:
      key: values/data/global/cteregistrationtoken
---
# Source: devconf-template/templates/hostedClusterTemplate.yaml
apiVersion: hypershift.openshift.io/v1alpha1
kind: HostedCluster
metadata:
  name: default-cluster-definition-bare-cp
spec:
  dns:
    baseDomain: default-cluster-definition-bare-cp.example.com
  etcd:
    managed:
      storage:
        persistentVolume:
          size: 8Gi
          storageClassName: cte-sc-default-cluster-definition-bare-cp
        restoreSnapshotURL: null
        type: PersistentVolume
    managementType: Managed
  networking:
    clusterNetwork:
    - cidr: 10.132.0.0/14
    networkType: OVNKubernetes
    serviceNetwork:
    - cidr: 172.31.0.0/16
  platform:
    type: None
  pullSecret:
    name: hypershift-pull-secret
  release:
    image: quay.io/openshift-release-dev/ocp-release:4.14.3-x86_64
  # Fixme: this needs a dynamic key generated in vault / cluster at run time.
  # vault is preferred as the objects are versioned.
  # secretEncryption:
  #   aescbc:
  #     activeKey:
  #       name: default-cluster-definition-bare-cp-etcd-key
  sshKey:
    name: cluster-ssh-key
  infraID: default-cluster-definition-bare-cp
  controllerAvailabilityPolicy: 
  
  services:
  - service: APIServer
    servicePublishingStrategy:
      type: 
      nodePort:
        address: 10.0.0.1
  - service: OAuthServer
    servicePublishingStrategy:
      type: 
      nodePort:
        address: 10.0.0.1
  - service: OIDC
    servicePublishingStrategy:
      type: 
      nodePort:
        address: 10.0.0.1
  - service: Konnectivity
    servicePublishingStrategy:
      type: 
      nodePort:
        address: 10.0.0.1
  - service: Ignition
    servicePublishingStrategy:
      type: 
      nodePort:
        address: 10.0.0.1
---
# Source: devconf-template/templates/nodePool.yaml
apiVersion: hypershift.openshift.io/v1alpha1
kind: NodePool
metadata:
  name: 'np-default-cluster-definition-bare-cp'
spec:
  clusterName: default-cluster-definition-bare-cp
  management:
    autoRepair: false
    replace:
      rollingUpdate:
        maxSurge: 1
        maxUnavailable: 0
      strategy: RollingUpdate
    upgradeType: InPlace
  platform:
    kubevirt:
      compute:
        cores: 4
        memory: 4096M
      rootVolume:
        diskImage:
          containerDiskImage: quay.io/containerdisks/rhcos:4.10
        persistent:
          size: 20G
        type: Persistent
    type: KubeVirt
  release:
    image: >-
      quay.io/openshift-release-dev/ocp-release:4.14.3-x86_64
  replicas: ${ .nodepoolReplicas }
